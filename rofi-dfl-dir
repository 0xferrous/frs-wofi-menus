#!/usr/bin/env bash

# DeFiLlama Protocol Selector using Rofi
# Opens selected protocol's website in default browser

set -euo pipefail

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/dfl-common.sh"

# Main logic
main() {
    # Check if rofi is installed
    if ! command -v rofi &> /dev/null; then
        echo "Error: rofi is not installed. Please install it first." >&2
        exit 1
    fi

    # Ensure cache is available
    ensure_cache

    # Get the list of protocol names
    local protocol_names
    protocol_names=$(get_protocol_names)

    if [[ -z "$protocol_names" ]]; then
        echo "Error: No protocols found" >&2
        exit 1
    fi

    # Show rofi menu and get selection
    local selected
    selected=$(echo "$protocol_names" | rofi -dmenu -p "Select DeFi Protocol" -i -matching fuzzy)

    if [[ -n "$selected" ]]; then
        open_protocol "$selected"
    fi
}

# Handle command line arguments
case "${1:-}" in
    --refresh|-r)
        handle_refresh
        ;;
    --cache-info|-i)
        show_cache_info
        ;;
    --help|-h)
        show_help "$(basename "$0")" "Rofi"
        ;;
    *)
        main
        ;;
esac